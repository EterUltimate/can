/*# AI åŠ©æ‰‹ - å¤©æ°”æŸ¥è¯¢ä¸å¯¹è¯ç³»ç»Ÿ

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªæ”¯æŒè‡ªå®šä¹‰ API åœ°å€ã€å¤šæ¨¡å‹é€‰æ‹©ã€æµå¼å“åº”ä¸ Token è´¹ç”¨ç»Ÿè®¡çš„ Web èŠå¤©ç•Œé¢ï¼Œä½œä¸ºè¯¾ç¨‹ä½œä¸šå¼€å‘å®Œæˆã€‚

---

## ğŸ“œ å¼€æºè®¸å¯

æœ¬é¡¹ç›®ä»£ç é‡‡ç”¨ **MIT License** å¼€æºï¼ˆè¯¦è§ [`LICENSE`](LICENSE) æ–‡ä»¶ï¼‰ã€‚  
ä½ å¯ä»¥è‡ªç”±åœ°ï¼š

- âœ… é˜…è¯»ã€å­¦ä¹ ã€å‚è€ƒå®ç°æ€è·¯ï¼›
- âœ… åœ¨ä¸ªäººé¡¹ç›®æˆ–éå­¦æœ¯åœºæ™¯ä¸­ä½¿ç”¨ï¼›
- âœ… ä¿®æ”¹å¹¶ç”¨äºå¼€æºè´¡çŒ®ï¼ˆéœ€ä¿ç•™åŸä½œè€…ç‰ˆæƒå£°æ˜ï¼‰ã€‚

---

## ğŸš« å­¦æœ¯è¯šä¿¡ç‰¹åˆ«å£°æ˜

> âš ï¸ **æœ¬é¡¹ç›®ä¸ºåŸåˆ›è¯¾ç¨‹ä½œä¸šï¼Œä¸¥ç¦ä»»ä½•å½¢å¼çš„å­¦æœ¯ä¸ç«¯è¡Œä¸ºï¼**

**æ˜ç¡®ç¦æ­¢ä»¥ä¸‹ç”¨é€”**ï¼š
- å°†æœ¬é¡¹ç›®çš„å…¨éƒ¨æˆ–éƒ¨åˆ†ä»£ç ç›´æ¥æäº¤ä¸ºè‡ªå·±çš„è¯¾ç¨‹ä½œä¸šã€å®éªŒæŠ¥å‘Šæˆ–æ¯•ä¸šè®¾è®¡ï¼›
- ä»…ä¿®æ”¹å˜é‡åã€æ³¨é‡Šæˆ–å°‘é‡é€»è¾‘åå£°ç§°æ˜¯è‡ªå·±ç‹¬ç«‹å®Œæˆçš„ä½œå“ï¼›
- åœ¨æœªæ˜ç¡®å¼•ç”¨ã€æœªè·å¾—æˆæƒçš„æƒ…å†µä¸‹ï¼Œå°†æœ¬é¡¹ç›®ç”¨äºä»»ä½•éœ€è¦â€œåŸåˆ›æ€§â€è¯„ä¼°çš„å­¦æœ¯åœºæ™¯ã€‚

**å…è®¸çš„åˆç†ä½¿ç”¨**ï¼š
- ä½œä¸ºæŠ€æœ¯å‚è€ƒï¼Œç†è§£å‰ç«¯äº¤äº’ã€API é›†æˆã€æµå¼å“åº”ç­‰å®ç°æ–¹å¼ï¼›
- åœ¨éå­¦æœ¯é¡¹ç›®ï¼ˆå¦‚ä¸ªäººåšå®¢ã€å¼€æºå·¥å…·ï¼‰ä¸­å¤ç”¨éƒ¨åˆ†ä»£ç ï¼ˆéµå®ˆ MIT è¦æ±‚ï¼‰ï¼›
- å¼•ç”¨æœ¬é¡¹ç›®æ—¶ï¼Œè¯·æ³¨æ˜åŸå§‹ä½œè€…ä¸é¡¹ç›®é“¾æ¥ã€‚

> ğŸ“Œ **é‡è¦æé†’**ï¼š  
> å¼€æº â‰  æ”¾å¼ƒè‘—ä½œæƒ â‰  å…è®¸æŠ„è¢­ã€‚  
> æ ¹æ®ã€Šé«˜ç­‰å­¦æ ¡ç§‘å­¦æŠ€æœ¯å­¦æœ¯è§„èŒƒæŒ‡å—ã€‹åŠå¤šæ•°é«˜æ ¡è§„å®šï¼Œ**æœªç»å£°æ˜ç›´æ¥ä½¿ç”¨ä»–äººå¼€æºä»£ç ä½œä¸ºä¸ªäººä½œä¸šæˆæœï¼Œå±äºå­¦æœ¯ä¸ç«¯è¡Œä¸º**ã€‚

---

## ğŸ™ è‡´è°¢ä¸äº¤æµ

æ¬¢è¿æå‡º Issue æˆ– PR è¿›è¡ŒæŠ€æœ¯è®¨è®ºï¼  
ä½†è¯·å‹¿è¯·æ±‚â€œå¸®æˆ‘æ”¹æˆå¦ä¸€ä¸ªä½œä¸šâ€æˆ–â€œå»æ‰ä½œè€…ä¿¡æ¯â€â€”â€”è¿™è¿èƒŒæœ¬é¡¹ç›®å¼€æºåˆè¡·ã€‚

ä½œè€…ï¼š[EterUltimate]  
é‚®ç®±ï¼š1831303476@qq.com
å­¦æ ¡ï¼š[zjnu]
*/
// ========== å…¨å±€çŠ¶æ€ ==========
let settings = {
  apiKey: '',
  model: '',
  apiBaseUrl: 'https://api.gemai.cc'
};

let totalInputTokens = 0;
let totalOutputTokens = 0;

// ========== å·¥å…·å‡½æ•° ==========
function getFullUrl(endpoint) {
  const base = settings.apiBaseUrl.replace(/\/+$/, '');
  return `${base}${endpoint.startsWith('/') ? '' : '/'}${endpoint}`;
}

function loadSettings() {
  const saved = localStorage.getItem('agentSettings');
  if (saved) {
    const parsed = JSON.parse(saved);
    settings = { ...settings, ...parsed };
  }
  // åŠ è½½ Token ç»Ÿè®¡
  const tokens = JSON.parse(localStorage.getItem('tokenStats') || '{}');
  totalInputTokens = tokens.in || 0;
  totalOutputTokens = tokens.out || 0;
}

function saveSettings() {
  localStorage.setItem('agentSettings', JSON.stringify(settings));
}

function saveTokenStats() {
  localStorage.setItem('tokenStats', JSON.stringify({
    in: totalInputTokens,
    out: totalOutputTokens
  }));
}

// ========== é¡µé¢è·¯ç”±åˆ†å‘ ==========
document.addEventListener('DOMContentLoaded', () => {
  loadSettings();
  
  // è®¾ç½®å¯¼èˆªé«˜äº®
  const currentPage = window.location.pathname.split('/').pop().replace('.html', '') || 'chat';
  document.querySelectorAll('.top-nav a').forEach(link => {
    if (link.getAttribute('href').includes(currentPage)) {
      link.classList.add('active');
    }
  });

  // ä¸»é¢˜åˆå§‹åŒ–
  const savedTheme = localStorage.getItem('theme') || 'light';
  if (savedTheme === 'dark') document.body.classList.add('dark-theme');

  // æ ¹æ®é¡µé¢è·¯å¾„æ‰§è¡Œä¸åŒé€»è¾‘
  if (currentPage === 'chat') initChatPage();
  if (currentPage === 'weather') initWeatherPage();
  if (currentPage === 'settings') initSettingsPage();
  if (currentPage === 'analytics') initAnalyticsPage();
});

// ========== å„é¡µé¢åˆå§‹åŒ–å‡½æ•° ==========
async function initChatPage() {
  const sendBtn = document.getElementById('sendBtn');
  const input = document.getElementById('messageInput');
  const messagesContainer = document.querySelector('.chat-messages');

  // åŠ è½½å†å²æ¶ˆæ¯ï¼ˆå¯é€‰æ‰©å±•ï¼‰
  addMessage("ä½ å¥½ï¼æˆ‘æ˜¯ AI åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ", 'ai');

  sendBtn?.addEventListener('click', handleSendMessage);
  input?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  });

  async function handleSendMessage() {
    const msg = input.value.trim();
    if (!msg) return;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage(msg, 'user');
    input.value = '';

    // æ£€æŸ¥æ˜¯å¦è®¾ç½®äº† API Key
    if (!settings.apiKey) {
      addMessage("âš ï¸ è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­é…ç½®ä½ çš„ API å¯†é’¥ï¼", 'ai');
      return;
    }

    // æ„é€ æ¶ˆæ¯å†å²ï¼ˆç®€å•ç‰ˆï¼šåªå–æœ€è¿‘å‡ æ¡ï¼Œé¿å…è¿‡é•¿ï¼‰
    const history = Array.from(messagesContainer.querySelectorAll('.message')).map(el => {
      const sender = el.classList.contains('user-message') ? 'user' : 'assistant';
      return { role: sender, content: el.textContent };
    }).filter(msg => msg.role && msg.content);

    // ç¡®ä¿æœ€åä¸€æ¡æ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼ˆå½“å‰è¿™æ¡ï¼‰
    const messages = [...history.slice(-8), { role: 'user', content: msg }];

    // æ˜¾ç¤ºâ€œAI æ­£åœ¨æ€è€ƒ...â€
    const aiMessageEl = document.createElement('div');
    aiMessageEl.className = 'message ai-message streaming';
    aiMessageEl.innerHTML = '<i>æ€è€ƒä¸­...</i>';
    messagesContainer.appendChild(aiMessageEl);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    try {
      const response = await fetch(getFullUrl('/v1/chat/completions'), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${settings.apiKey}`,
        },
        body: JSON.stringify({
          model: settings.model || 'qwen-max', // é»˜è®¤æ¨¡å‹
          messages: messages,
          stream: true, // å¯ç”¨æµå¼å“åº”
          temperature: 0.7,
        }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      if (!response.body) {
        throw new Error('å“åº”æ—  bodyï¼Œå¯èƒ½ä¸æ”¯æŒæµå¼');
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullResponse = '';
      let isDone = false;

      // æ¸…ç©ºâ€œæ€è€ƒä¸­â€æç¤º
      aiMessageEl.textContent = '';

      while (!isDone) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n').filter(line => line.trim().startsWith('data: '));

        for (const line of lines) {
          if (line === 'data: [DONE]') {
            isDone = true;
            break;
          }

          try {
            const data = line.substring(6); // å»æ‰ "data: "
            if (!data.trim()) continue;

            const json = JSON.parse(data);
            const content = json.choices?.[0]?.delta?.content || '';
            if (content) {
              fullResponse += content;
              aiMessageEl.textContent = fullResponse;
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
          } catch (e) {
            console.warn('è§£æ SSE æ•°æ®å¤±è´¥:', line, e);
          }
        }
      }

      // ç»Ÿè®¡ tokensï¼ˆå¦‚æœ API è¿”å›äº† usageï¼‰
      // æ³¨æ„ï¼šæµå¼å“åº”é€šå¸¸ä¸ä¼šåœ¨ä¸­é—´è¿”å› usageï¼Œéœ€é¢å¤–è¯·æ±‚æˆ–ä¾èµ–éæµå¼
      // è¿™é‡Œæˆ‘ä»¬æš‚æ—¶æ— æ³•è·å–å‡†ç¡® token æ•°ï¼ˆé™¤éæ”¹ç”¨éæµå¼ï¼‰
      // ä½œä¸ºæ›¿ä»£ï¼Œæˆ‘ä»¬å¯ä»¥ä¼°ç®—ï¼ˆæŒ‰å­—ç¬¦æ•°ç²—ç•¥æ¢ç®—ï¼‰ï¼Œæˆ–åç»­åŠ ä¸€ä¸ªéæµå¼ fallback

      // ä¿å­˜ token ç»Ÿè®¡ï¼ˆè¿™é‡Œå…ˆè·³è¿‡ï¼Œå› æµå¼æ—  usageï¼›ä½ å¯åœ¨ analytics é¡µè¯´æ˜ï¼‰
      // totalInputTokens += ...; totalOutputTokens += ...; saveTokenStats();

    } catch (error) {
      console.error('API è°ƒç”¨å¤±è´¥:', error);
      aiMessageEl.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}<br>
        <small>è¯·æ£€æŸ¥ API å¯†é’¥ã€URL æˆ–ç½‘ç»œ</small>`;
    }
  }
}

function initWeatherPage() {
  const cityInput = document.getElementById('cityInput');
  const weatherDisplay = document.getElementById('weatherDisplay');
  
  cityInput.value = localStorage.getItem('lastCity') || 'æ¸©å·';
  fetchWeather(cityInput.value);
  
  let debounce;
  cityInput?.addEventListener('input', (e) => {
    clearTimeout(debounce);
    debounce = setTimeout(() => {
      const city = e.target.value.trim();
      if (city) {
        localStorage.setItem('lastCity', city);
        fetchWeather(city);
      }
    }, 500);
  });
}

async function fetchWeather(city) {
  const el = document.getElementById('weatherDisplay');
  el.innerHTML = '<p>è·å–å¤©æ°”ä¸­...</p>';
  try {
    const res = await fetch(`https://wttr.in/${encodeURIComponent(city)}?format=j1`);
    const data = await res.json();
    const current = data.current_condition[0];
    el.innerHTML = `
      <div class="weather-icon">ğŸŒ¦</div>
      <h2>${city}</h2>
      <p>${current.weatherDesc[0].value}</p>
      <p style="font-size: 24px; margin: 10px 0;">${current.temp_C}Â°C</p>
      <p>ä½“æ„Ÿ ${current.FeelsLikeC}Â°C | æ¹¿åº¦ ${current.humidity}%</p>
    `;
  } catch (e) {
    el.innerHTML = `<p>âŒ æ— æ³•è·å– "${city}" çš„å¤©æ°”</p>`;
  }
}

function initSettingsPage() {
  // å¡«å……å·²ä¿å­˜è®¾ç½®
  document.getElementById('apiKey').value = settings.apiKey;
  document.getElementById('apiBaseUrl').value = settings.apiBaseUrl;
  
  // ä¿å­˜æŒ‰é’®
  document.getElementById('saveSettings')?.addEventListener('click', () => {
    settings.apiKey = document.getElementById('apiKey').value.trim();
    settings.apiBaseUrl = document.getElementById('apiBaseUrl').value.trim() || 'https://api.gemai.cc';
    
    // ç®€å• URL æ ¡éªŒ
    try {
      new URL(settings.apiBaseUrl);
    } catch (e) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API åŸºç¡€ URLï¼');
      return;
    }
    
    saveSettings();
    alert('âœ… è®¾ç½®å·²ä¿å­˜ï¼');
  });
  
  // åˆ‡æ¢ä¸»é¢˜
  document.getElementById('themeToggle')?.addEventListener('click', () => {
    document.body.classList.toggle('dark-theme');
    localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
  });
}

function initAnalyticsPage() {
  const MODEL_METADATA = {
    "gpt-4o": { price: { input: 5, output: 15 } },
    "gpt-4o-mini": { price: { input: 0.15, output: 0.6 } },
    "qwen-max": { price: { input: 2, output: 6 } }
  };
  
  const model = settings.model || 'gpt-4o-mini';
  const meta = MODEL_METADATA[model] || { price: { input: 0.15, output: 0.6 } };
  
  const inCost = (totalInputTokens * meta.price.input) / 1e6;
  const outCost = (totalOutputTokens * meta.price.output) / 1e6;
  
  document.getElementById('thisSession').innerHTML = `
    <div class="metric-card">
      <span class="metric-label">è¾“å…¥ Tokens</span>
      <span class="metric-value">${totalInputTokens.toLocaleString()}</span>
    </div>
    <div class="metric-card">
      <span class="metric-label">è¾“å‡º Tokens</span>
      <span class="metric-value">${totalOutputTokens.toLocaleString()}</span>
    </div>
    <div class="metric-card">
      <span class="metric-label">æœ¬æ¬¡è´¹ç”¨</span>
      <span class="metric-value">~$${(inCost + outCost).toFixed(5)}</span>
    </div>
  `;
  
  // é‡ç½®æŒ‰é’®ï¼ˆä»…æ¼”ç¤ºï¼‰
  document.getElementById('resetStats')?.addEventListener('click', () => {
    if (confirm('é‡ç½®æ‰€æœ‰ç»Ÿè®¡ï¼Ÿ')) {
      totalInputTokens = 0;
      totalOutputTokens = 0;
      saveTokenStats();
      location.reload();
    }
  });
}

// ========== é€šç”¨å‡½æ•° ==========
function addMessage(text, sender) {
  const messages = document.querySelector('.chat-messages');
  if (!messages) return;
  
  const div = document.createElement('div');
  div.className = `message ${sender}-message`;
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;

}
